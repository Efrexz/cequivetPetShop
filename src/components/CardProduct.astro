---
import WhatsAppIcon from "@assets/icons/whatsapp.svg";
import Logo from "@assets/images/logo.webp";
import TailwindSpinner from "@assets/icons/tailwindSpinner.svg";

const { product } = Astro.props;

const productDetailUrl = `/products/${product.id}`;

const whatsappMessage = `Hola, me interesa el producto ${product.name} (${product.price}). ¿Podrías darme más información?`;
const whatsappLink = `https://wa.me/+51970691590?text=${encodeURIComponent(whatsappMessage)}`;
---

<div
  class="w-full h-full flex flex-col bg-white rounded-xl shadow-lg border border-gray-100 transform transition-all duration-300 ease-in-out hover:scale-105 hover:shadow-2xl hover:border-[#00BD9D] cursor-pointer"
  onclick={`window.location.href = '${productDetailUrl}';`}
>
  <div class="overflow-hidden rounded-t-xl relative h-40">
    <!-- Skeleton para la imagen -->
    <div
      id={`image-skeleton-${product.id}`}
      class="absolute inset-0 flex-col gap-4 w-full h-full flex items-center justify-center bg-gray-200 animate-pulse"
    >
      <div
        class="w-16 h-16 border-8 text-[#FF7F11] text-4xl animate-spin border-gray-300 flex items-center justify-center border-t-[#FF7F11] rounded-full"
      >
        <TailwindSpinner />
      </div>
    </div>

    <img
      id={`product-card-image-${product.id}`}
      src={product.image ?? Logo.src}
      alt={`Imagen de ${product.name}`}
      class="w-full h-full object-contain rounded-t-xl transform transition-transform duration-300 ease-in-out hover:scale-120 absolute inset-0 opacity-0"
      loading="lazy"
    />
  </div>
  <div class="p-4 flex flex-col flex-grow text-center">
    <div class="flex-none h-14 overflow-hidden mb-1">
      <h4 class="font-bold text-lg text-[#007872] leading-tight line-clamp-2">
        {product.name}
      </h4>
    </div>

    <div class="flex-none h-12 overflow-hidden mb-3">
      <p class="text-sm text-gray-600 line-clamp-2">
        {product.description}
      </p>
    </div>

    <div
      class="mt-auto pt-3 border-t border-gray-100 flex flex-col sm:flex-row items-center justify-between gap-3"
    >
      <span
        class="text-2xl font-extrabold text-orange-500 order-1 sm:order-1 w-full sm:w-auto whitespace-nowrap"
      >
        {product.price}
      </span>
      <a
        href={whatsappLink}
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center justify-center gap-2 px-4 py-2 rounded-full bg-[#25D366] text-white font-semibold text-sm shadow-lg shadow-green-600/30 hover:bg-[#1DA851] transition transform hover:scale-105 w-full sm:w-auto order-2 sm:order-2 button-hover-effect"
        aria-label={`Pedir ${product.name} por WhatsApp`}
        onclick="event.stopPropagation()"
      >
        <WhatsAppIcon class="w-5 h-5" />
        Pedir
      </a>
    </div>
  </div>
</div>

<script define:vars={{ product: product, Logo: Logo.src }}>
  document.addEventListener("DOMContentLoaded", () => {
    const productImage = document.getElementById(
      `product-card-image-${product.id}`
    );
    const imageSkeleton = document.getElementById(
      `image-skeleton-${product.id}`
    );

    function loadImage(src) {
      if (!productImage || !imageSkeleton) return;

      imageSkeleton.classList.remove("hidden");
      productImage.classList.add("opacity-0");

      const img = new Image();
      img.src = src;
      img.onload = () => {
        productImage.src = src;
        productImage.classList.remove("opacity-0");
        productImage.classList.add("opacity-100");
        imageSkeleton.classList.add("hidden");
      };
      img.onerror = () => {
        productImage.src = Logo;
        productImage.classList.remove("opacity-0");
        productImage.classList.add("opacity-100");
        imageSkeleton.classList.add("hidden");
        console.error(
          "Error al cargar la imagen del producto en la tarjeta:",
          src
        );
      };
    }

    // Cargar la imagen cuando el DOM esté listo
    loadImage(product.image || Logo);
  });
</script>
